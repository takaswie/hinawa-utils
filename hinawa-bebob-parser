#!/usr/bin/env python3
# SPDX-License-Identifier: GPL-3.0-or-later
# Copyright (C) 2018 Takashi Sakamoto

from hinawa_utils.bebob.plug_parser import PlugParser

from sys import argv, exit
from pathlib import Path
import json

def print_help(reason=""):
    if len(reason) > 0:
        print(reason)
        print('')
    print('Usage:')
    print('  {} CDEV MODE'.format(argv[0]))
    print('')
    print('  where:')
    print('    CDEV: the path to special file for Linux FireWire character device (e.g. /dev/fw[0-9]+)')
    print('    MODE: dump mode (0: id-only, 1: whole as json)')

def dump_plug_info_to_stdio_as_json(parser):
    info = {
        'units': parser.unit_plugs,
        'subunits': parser.subunit_plugs,
        'function-blocks': parser.function_block_plugs,
        'stream-formats': parser.stream_formats,
    }
    print(json.dumps(info))


def dump_plug_info_to_stdio_as_ids_only(parser):
    for type, dir_plugs in parser.unit_plugs.items():
        for dir, plugs in dir_plugs.items():
            for num, plug in plugs.items():
                print(type, dir, num, plug['name'])

    for type, dir_plugs in parser.subunit_plugs.items():
        for id, id_plugs in dir_plugs.items():
            for dir, dir_plugs in id_plugs.items():
                for plug_id, attrs in dir_plugs.items():
                    print(type, id, dir, plug_id, attrs['name'])

    for type, type_plugs in parser.function_block_plugs.items():
        for id, id_plugs in type_plugs.items():
            for fb_type, fb_type_plugs in id_plugs.items():
                for fb_id, fb_id_plugs in fb_type_plugs.items():
                    for plug_id, attrs in fb_id_plugs['outputs'].items():
                        print(type, id, fb_type, fb_id, 'output', plug_id,
                              attrs['name'])
                    for plug_id, attrs in fb_id_plugs['inputs'].items():
                        print(type, id, fb_type, fb_id, 'input', plug_id,
                              attrs['name'])

    for type, dir_fmts in parser.stream_formats.items():
        for dir, fmts in dir_fmts.items():
            for i, entries in fmts.items():
                for j, entry in enumerate(entries):
                    print(type, dir, i, j, entry['type'])

ops = {
    '0': dump_plug_info_to_stdio_as_ids_only,
    '1': dump_plug_info_to_stdio_as_json,
}

if len(argv) < 3:
    print_help("Missing arguments")
    exit(1)

path = Path(argv[1])
if not path.exists():
    print_help("{} is not found.Â¥n".format(path))
    exit(1)
elif not path.is_char_device():
    print_help("{} is not special file for character device.".format(path))
    exit(1)
fullpath = str(path)

mode = argv[2]
if mode not in ops:
    print_help('Invalid mode')
    exit(1)
op = ops[mode]

parser = PlugParser(fullpath)
parser.listen()
parser.parse()
parser.unlisten()

op(parser)
